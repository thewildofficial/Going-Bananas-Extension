<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Going Bananas - REAL Google OAuth Test</title>
    <script type="module">
        // Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSSK4WM8my-F2MxrPV7gcW_81BmWzfGXk",
            authDomain: "going-bananas-chrome-extension.firebaseapp.com",
            projectId: "going-bananas-chrome-extension",
            storageBucket: "going-bananas-chrome-extension.firebasestorage.app",
            messagingSenderId: "94912499369",
            appId: "1:94912499369:web:082f8e32cd25aeee4863b8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Backend URL
        const BACKEND_URL = 'http://localhost:3003';

        // Global variables
        let currentUser = null;
        let userProfile = null;

        // DOM elements
        let signInBtn, signOutBtn, userInfo, profileSection, analysisSection;
        let step1, step2, step3, step4, progressFill;

        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            signInBtn = document.getElementById('signInBtn');
            signOutBtn = document.getElementById('signOutBtn');
            userInfo = document.getElementById('userInfo');
            profileSection = document.getElementById('profileSection');
            analysisSection = document.getElementById('analysisSection');

            step1 = document.getElementById('step1');
            step2 = document.getElementById('step2');
            step3 = document.getElementById('step3');
            step4 = document.getElementById('step4');
            progressFill = document.getElementById('progressFill');

            // Check if user is already signed in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await handleSignedIn(user);
                } else {
                    handleSignedOut();
                }
            });

            // Add event listeners
            signInBtn.addEventListener('click', signInWithGoogle);
            signOutBtn.addEventListener('click', signOutUser);
        });

        async function signInWithGoogle() {
            try {
                signInBtn.textContent = 'üîÑ Signing in...';
                signInBtn.disabled = true;

                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Get ID token
                const idToken = await user.getIdToken();

                // Send to backend
                await verifyWithBackend(idToken);

                showSuccess('Successfully signed in with Google!', 'success');

            } catch (error) {
                console.error('Sign in error:', error);
                showError(`Sign in failed: ${error.message}`);
            } finally {
                signInBtn.textContent = 'üîê Sign in with Google';
                signInBtn.disabled = false;
            }
        }

        async function verifyWithBackend(idToken) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ idToken })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('‚úÖ Backend verification successful:', data);
                    return data;
                } else {
                    throw new Error(data.error || 'Backend verification failed');
                }
            } catch (error) {
                throw new Error(`Backend verification failed: ${error.message}`);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                currentUser = null;
                userProfile = null;
                showSuccess('Successfully signed out!', 'info');
            } catch (error) {
                showError(`Sign out failed: ${error.message}`);
            }
        }

        async function handleSignedIn(user) {
            console.log('üîê User signed in:', user);

            // Update UI
            signInBtn.style.display = 'none';
            signOutBtn.style.display = 'block';

            // Show user info
            userInfo.innerHTML = `
                <div class="user-avatar">
                    <img src="${user.photoURL || '/default-avatar.png'}" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%;">
                </div>
                <div class="user-details">
                    <h3>${user.displayName || 'User'}</h3>
                    <p>${user.email}</p>
                    <p class="user-id">ID: ${user.uid.substring(0, 8)}...</p>
                </div>
            `;

            userInfo.style.display = 'flex';

            // Enable next steps
            updateProgress(2);
            profileSection.style.display = 'block';

            // Try to get existing profile
            await checkExistingProfile();
        }

        async function handleSignedOut() {
            console.log('üëã User signed out');

            // Update UI
            signInBtn.style.display = 'block';
            signOutBtn.style.display = 'none';
            userInfo.style.display = 'none';
            profileSection.style.display = 'none';
            analysisSection.style.display = 'none';

            updateProgress(1);
        }

        async function checkExistingProfile() {
            if (!currentUser) return;

            try {
                // Generate user ID (in real app this would come from backend)
                const userId = `user-${currentUser.uid.substring(0, 8)}`;

                const response = await fetch(`${BACKEND_URL}/api/personalization/profile/${userId}`);

                if (response.ok) {
                    const data = await response.json();
                    userProfile = data.profile;
                    showSuccess('Found existing profile!', 'success');
                    analysisSection.style.display = 'block';
                    updateProgress(4);
                } else {
                    showInfo('No existing profile found. Create one below.');
                }
            } catch (error) {
                console.log('No existing profile:', error.message);
            }
        }

        async function createUserProfile() {
            if (!currentUser) {
                showError('Please sign in first');
                return;
            }

            const createBtn = document.getElementById('createProfileBtn');
            createBtn.textContent = 'üîÑ Creating...';
            createBtn.disabled = true;

            try {
                const profileData = {
                    userId: `user-${currentUser.uid.substring(0, 8)}`,
                    version: "1.0",
                    completedAt: new Date().toISOString(),

                    // User's real info from Google
                    demographics: {
                        ageRange: "26_40",
                        jurisdiction: {
                            primaryCountry: "US",
                            primaryState: "CA",
                            frequentTravel: false,
                            isExpatriate: false,
                            multipleJurisdictions: []
                        },
                        occupation: "technology"
                    },

                    digitalBehavior: {
                        techSophistication: {
                            readingFrequency: "read_thoroughly",
                            comfortLevel: "advanced",
                            preferredExplanationStyle: "technical_detailed"
                        },
                        usagePatterns: {
                            primaryActivities: ["work_productivity"],
                            signupFrequency: "monthly",
                            deviceUsage: "desktop_primary"
                        }
                    },

                    riskPreferences: {
                        privacy: {
                            overallImportance: "very_important",
                            sensitiveDataTypes: [
                                { dataType: "financial_information", priorityLevel: 1 }
                            ],
                            dataProcessingComfort: {
                                domesticProcessing: "comfortable",
                                internationalTransfers: "cautious",
                                thirdPartySharing: "uncomfortable",
                                aiProcessing: "cautious",
                                longTermStorage: "uncomfortable"
                            }
                        },
                        financial: {
                            paymentApproach: "cautious",
                            feeImpact: "moderate",
                            financialSituation: "stable_employment",
                            subscriptionTolerance: {
                                autoRenewal: "cautious",
                                freeTrialToSubscription: "cautious",
                                priceChanges: "reasonable_notice"
                            }
                        },
                        legal: {
                            arbitrationComfort: "prefer_courts",
                            liabilityTolerance: "reasonable_limitations",
                            legalKnowledge: {
                                contractLaw: "intermediate",
                                privacyLaw: "intermediate",
                                consumerRights: "basic"
                            },
                            previousIssues: "no_issues"
                        }
                    },

                    contextualFactors: {
                        dependentStatus: "just_myself",
                        specialCircumstances: ["handles_sensitive_data"],
                        decisionMakingPriorities: [
                            { factor: "privacy_protection", priority: 1 },
                            { factor: "security_safety", priority: 2 },
                            { factor: "cost_value", priority: 3 },
                            { factor: "features_functionality", priority: 4 },
                            { factor: "ease_of_use", priority: 5 },
                            { factor: "customer_support", priority: 6 },
                            { factor: "terms_fairness", priority: 7 },
                            { factor: "reputation_reviews", priority: 8 },
                            { factor: "compliance_legal", priority: 9 }
                        ],
                        alertPreferences: {
                            interruptionTiming: "moderate_and_high",
                            educationalContent: "occasionally_important",
                            alertFrequencyLimit: 10,
                            learningMode: true
                        }
                    }
                };

                const response = await fetch(`${BACKEND_URL}/api/personalization/profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (response.ok) {
                    userProfile = data.profile;
                    showSuccess('Profile created successfully!', 'success');

                    // Show profile summary
                    const profileSummary = document.getElementById('profileSummary');
                    profileSummary.innerHTML = `
                        <div class="profile-card">
                            <h4>üë§ Profile Created</h4>
                            <p><strong>User ID:</strong> ${userProfile.userId}</p>
                            <p><strong>Occupation:</strong> ${userProfile.demographics.occupation}</p>
                            <p><strong>Location:</strong> ${userProfile.demographics.jurisdiction.primaryCountry}</p>
                            <p><strong>Privacy Risk:</strong> ${userProfile.computedProfile?.riskTolerance?.privacy || 'N/A'}</p>
                            <p><strong>Financial Risk:</strong> ${userProfile.computedProfile?.riskTolerance?.financial || 'N/A'}</p>
                        </div>
                    `;

                    analysisSection.style.display = 'block';
                    updateProgress(4);
                } else {
                    throw new Error(data.error || 'Profile creation failed');
                }

            } catch (error) {
                showError(`Profile creation failed: ${error.message}`);
            } finally {
                createBtn.textContent = 'üìù Create Profile';
                createBtn.disabled = false;
            }
        }

        async function analyzeTerms() {
            if (!userProfile) {
                showError('Please create a profile first');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.textContent = 'üîÑ Analyzing...';
            analyzeBtn.disabled = true;

            try {
                const termsText = `This comprehensive service agreement includes extensive data collection, third-party sharing arrangements, automatic subscription renewal with significant price increases, mandatory arbitration clauses, and broad liability limitations that substantially restrict user rights and protections. Users have no ability to delete their data or opt out of tracking.`;

                const analysisData = {
                    text: termsText,
                    userId: userProfile.userId,
                    options: {
                        detail_level: 'comprehensive',
                        multiPass: true,
                        contextAware: true,
                        categories: ['privacy', 'liability', 'termination', 'payment']
                    }
                };

                const response = await fetch(`${BACKEND_URL}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisData)
                });

                const data = await response.json();

                if (response.ok) {
                    const analysis = data.analysis;
                    const resultsDiv = document.getElementById('analysisResults');

                    resultsDiv.innerHTML = `
                        <div class="analysis-card">
                            <h4>ü§ñ AI Analysis Results</h4>
                            <div class="risk-score">
                                <span class="score">${analysis.risk_score}/10</span>
                                <span class="level">${analysis.risk_level}</span>
                            </div>
                            <p><strong>Multi-pass:</strong> ${analysis.multi_pass_analysis ? '‚úÖ' : '‚ùå'}</p>
                            <p><strong>Personalization:</strong> ${analysis.personalization_applied ? '‚úÖ Applied' : '‚ùå Not applied'}</p>
                            <p><strong>Risk Areas:</strong> ${analysis.major_clauses?.clauses?.length || 0} identified</p>

                            <div class="clauses">
                                <h5>Major Risk Areas:</h5>
                                ${(analysis.major_clauses?.clauses || []).slice(0, 3).map(clause =>
                                    `<div class="clause-item">
                                        <strong>${clause.title}</strong> (${clause.importance} risk)
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    `;

                    showSuccess('Analysis completed successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }

            } catch (error) {
                showError(`Analysis failed: ${error.message}`);
            } finally {
                analyzeBtn.textContent = 'üîç Analyze Terms';
                analyzeBtn.disabled = false;
            }
        }

        function updateProgress(step) {
            // Update step indicators
            [step1, step2, step3, step4].forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                }
            });

            // Update progress bar
            const progress = ((step - 1) / 3) * 100;
            progressFill.style.width = `${progress}%`;
        }

        function showSuccess(message, type = 'success') {
            showMessage(message, type);
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showInfo(message) {
            showMessage(message, 'info');
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(alert => alert.remove());

            // Add new alert
            document.body.insertBefore(alertDiv, document.body.firstChild);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Make functions global so HTML can call them
        window.signInWithGoogle = signInWithGoogle;
        window.signOutUser = signOutUser;
        window.createUserProfile = createUserProfile;
        window.analyzeTerms = analyzeTerms;
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .auth-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .auth-button {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .sign-out-btn {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
        }

        .user-info {
            display: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            align-items: center;
            gap: 20px;
        }

        .user-avatar img {
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .user-details h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .user-details p {
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .user-id {
            font-family: monospace;
            font-size: 0.9em;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section.hidden {
            display: none;
        }

        .action-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px 10px 0;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .action-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .profile-card, .analysis-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .profile-card h4, .analysis-card h4 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .risk-score {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .score {
            font-size: 2.5em;
            font-weight: bold;
            color: #e74c3c;
        }

        .level {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .clause-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .step-counter {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ecf0f1;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .step.active {
            background: #007bff;
            color: white;
            transform: scale(1.1);
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 30px;
            height: 2px;
            background: #ecf0f1;
            margin-left: 10px;
        }

        .step:last-child::after {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.5s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .flow-diagram {
            text-align: center;
            margin: 20px 0;
            font-size: 0.9em;
            color: #666;
        }

        .flow-diagram .arrow {
            margin: 0 10px;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê REAL Google OAuth Test</h1>
            <p>Sign in with your actual Google account and test the complete flow</p>
        </div>

        <div class="flow-diagram">
            <span>üîê Google Sign-In</span>
            <span class="arrow">‚Üí</span>
            <span>üìù User Profile</span>
            <span class="arrow">‚Üí</span>
            <span>ü§ñ AI Analysis</span>
        </div>

        <div class="step-counter">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="content">
            <!-- Authentication Section -->
            <div class="auth-section">
                <h3>üîê Step 1: Sign in with Google</h3>
                <p style="color: #666; margin: 15px 0;">Click the button below to sign in with your real Google account</p>

                <div class="auth-buttons">
                    <button class="auth-button" id="signInBtn">
                        üîê Sign in with Google
                    </button>
                    <button class="auth-button sign-out-btn" id="signOutBtn" style="display: none;">
                        üëã Sign Out
                    </button>
                </div>

                <div class="user-info" id="userInfo">
                    <!-- User info will be populated here -->
                </div>
            </div>

            <!-- Profile Creation Section -->
            <div class="section hidden" id="profileSection">
                <h3>üìù Step 2: Create Your Profile</h3>
                <p style="color: #666; margin-bottom: 15px;">Create a personalization profile that will customize your AI analysis</p>

                <button class="action-button" id="createProfileBtn" onclick="createUserProfile()">
                    üìù Create Profile
                </button>

                <div id="profileSummary"></div>
            </div>

            <!-- Analysis Section -->
            <div class="section hidden" id="analysisSection">
                <h3>ü§ñ Step 3: Test AI Analysis</h3>
                <p style="color: #666; margin-bottom: 15px;">Analyze terms of service using your personalized profile</p>

                <button class="action-button" id="analyzeBtn" onclick="analyzeTerms()">
                    üîç Analyze Terms
                </button>

                <div id="analysisResults"></div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin: 20px; color: #666;">
        <p><strong>Make sure your backend is running on port 3003!</strong></p>
        <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 4px;">
            PORT=3003 MOCK_GEMINI_API=true NODE_ENV=test node server.js
        </code>
    </div>
</body>
</html>

